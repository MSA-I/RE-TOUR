[33mcommit 8b30f0ed21b78fa3ff203cfa510b933f0cb78e84[m[33m ([m[1;36mHEAD[m[33m -> [m[1;32mmain[m[33m, [m[1;31morigin/main[m[33m, [m[1;31morigin/HEAD[m[33m)[m
Author: Moshe Sananens <hadmayotms@gmail.com>
Date:   Wed Feb 11 16:07:42 2026 +0200

    fix: resolve critical Step 1 blockers (CORS, auth, OpenAI removal)
    
    Fixes three proven blockers preventing Step 1 pipeline execution:
    
    P0 - CORS Preflight Failure:
    - Move SUPABASE_URL/SERVICE_ROLE_KEY loading inside serve() callback
    - Prevents module initialization failures blocking OPTIONS handler
    - Add explicit 200 status to OPTIONS responses
    - Add ENV_MISSING error handling with proper CORS headers
    
    P1 - 401 Unauthorized:
    - Add explicit Authorization header in useConstraintStackDepth hook
    - Update get-constraint-stack-depth CORS headers (add Allow-Methods)
    - Add explicit 200 status to OPTIONS response
    
    P2 - Schema Cache Miss:
    - Add migration to grant SELECT on [1;31mcamera_intents_with_spaces[m view
    - Grant access to authenticated and anon roles
    
    API_OPENAI Removal:
    - Remove all API_OPENAI references from edge functions
    - Remove dimension extraction (OpenAI-based) from Step 1
    - Remove QA validation (OpenAI-based) from batch jobs
    - Deprecate compose-pipeline-prompt function (OpenAI-dependent)
    - System now uses GEMINI and NANO BANANA APIs exclusively
    
    Fail-Loud Instrumentation:
    - Add STEP_START event emission on every edge function invocation
    - Add structured error codes (AUTH_MISSING, PHASE_MISMATCH, etc.)
    - Add UI error banner displaying pipeline.last_error
    - Enhanced frontend error logging with error codes
    
    Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>

[1mdiff --git a/.claude/settings.local.json b/.claude/settings.local.json[m
[1mindex 7d1c64b..bfc2cd5 100644[m
[1m--- a/.claude/settings.local.json[m
[1m+++ b/.claude/settings.local.json[m
[36m@@ -47,7 +47,16 @@[m
       "Bash(git commit:*)",[m
       "Bash(supabase functions list:*)",[m
       "Bash(supabase db dump:*)",[m
[31m-      "Bash(cat:*)"[m
[32m+[m[32m      "Bash(cat:*)",[m
[32m+[m[32m      "Bash(npm run lint)",[m
[32m+[m[32m      "Bash(where:*)",[m
[32m+[m[32m      "Bash(supabase db:*)",[m
[32m+[m[32m      "mcp__supabase__get_logs",[m
[32m+[m[32m      "mcp__supabase__list_edge_functions",[m
[32m+[m[32m      "Bash(deno check:*)",[m
[32m+[m[32m      "mcp__supabase__get_edge_function_details",[m
[32m+[m[32m      "mcp__supabase__list_rls_policies",[m
[32m+[m[32m      "Bash(supabase functions logs:*)"[m
     ][m
   },[m
   "enableAllProjectMcpServers": true,[m
[1mdiff --git a/src/components/WholeApartmentPipelineCard.tsx b/src/components/WholeApartmentPipelineCard.tsx[m
[1mindex 62a66a7..1b3c535 100644[m
[1m--- a/src/components/WholeApartmentPipelineCard.tsx[m
[1m+++ b/src/components/WholeApartmentPipelineCard.tsx[m
[36m@@ -61,6 +61,7 @@[m [mimport {[m
   ChevronDown,[m
   ChevronRight,[m
   AlertTriangle,[m
[32m+[m[32m  AlertCircle,[m
   Terminal,[m
   MoreVertical,[m
   Trash2,[m
[36m@@ -2237,6 +2238,10 @@[m [mexport const WholeApartmentPipelineCard = memo(function WholeApartmentPipelineCa[m
   const step2Out = stepOutputs["step2"] || stepOutputs["2"];[m
   const styledImageUploadId = step2Out?.upload_id || step2Out?.output_upload_id || null;[m
 [m
[32m+[m[32m  // Error banner state[m
[32m+[m[32m  const lastError = pipeline.last_error;[m
[32m+[m[32m  const hasError = !!lastError;[m
[32m+[m
   const onAction = useCallback([m
     (type: "generate" | "approve" | "reject" | "continue", meta?: Record<string, unknown>) => {[m
       setLastAction({ type, ts: Date.now(), meta });[m
[36m@@ -2416,8 +2421,13 @@[m [mexport const WholeApartmentPipelineCard = memo(function WholeApartmentPipelineCa[m
   }, [pipeline.id, styledImageUploadId, runBatchRenders, toast]);[m
 [m
   const handleRunTopDown = useCallback(() => {[m
[32m+[m[32m    console.log("[UI] Step 1 Generate button clicked", {[m
[32m+[m[32m      pipelineId: pipeline.id,[m
[32m+[m[32m      currentPhase: pipeline.whole_apartment_phase,[m
[32m+[m[32m      currentStep: pipeline.current_step[m
[32m+[m[32m    });[m
     runTopDown3D.mutate({ pipelineId: pipeline.id });[m
[31m-  }, [runTopDown3D, pipeline.id]);[m
[32m+[m[32m  }, [runTopDown3D, pipeline.id, pipeline.whole_apartment_phase, pipeline.current_step]);[m
 [m
   const handleRunStyle = useCallback(() => {[m
     const refIds = (pipeline.step_outputs as any)?.design_reference_ids || [];[m
[36m@@ -3025,6 +3035,53 @@[m [mexport const WholeApartmentPipelineCard = memo(function WholeApartmentPipelineCa[m
         </CardHeader>[m
 [m
         <CardContent className="space-y-4">[m
[32m+[m[32m          {/* Error Banner */}[m
[32m+[m[32m          {hasError && ([m
[32m+[m[32m            <div className="p-4 bg-destructive/10 border-2 border-destructive/50 rounded-lg">[m
[32m+[m[32m              <div className="flex items-start gap-3">[m
[32m+[m[32m                <AlertCircle className="w-5 h-5 text-destructive mt-0.5 flex-shrink-0" />[m
[32m+[m[32m                <div className="flex-1 min-w-0">[m
[32m+[m[32m                  <p className="text-sm font-semibold text-destructive">Pipeline Error</p>[m
[32m+[m[32m                  <p className="text-sm text-muted-foreground mt-1 break-words font-mono">{lastError}</p>[m
[32m+[m[32m                  <div className="flex gap-2 mt-3">[m
[32m+[m[32m                    <Button[m
[32m+[m[32m                      size="sm"[m
[32m+[m[32m                      variant="outline"[m
[32m+[m[32m                      onClick={async () => {[m
[32m+[m[32m                        await supabase[m
[32m+[m[32m                          .from("floorplan_pipelines")[m
[32m+[m[32m                          .update({ last_error: null, updated_at: new Date().toISOString() })[m
[32m+[m[32m                          .eq("id", pipeline.id);[m
[32m+[m[32m                        toast({ title: "Error cleared" });[m
[32m+[m[32m                        queryClient.invalidateQueries({ queryKey: ["floorplan-pipelines"] });[m
[32m+[m[32m                      }}[m
[32m+[m[32m                    >[m
[32m+[m[32m                      Clear Error[m
[32m+[m[32m                    </Button>[m
[32m+[m[32m                    <Button[m
[32m+[m[32m                      size="sm"[m
[32m+[m[32m                      variant="default"[m
[32m+[m[32m                      onClick={() => {[m
[32m+[m[32m                        // Determine which step to retry based on current step[m
[32m+[m[32m                        const stepToRetry = pipeline.current_step;[m
[32m+[m[32m                        if (stepToRetry === 1) {[m
[32m+[m[32m                          runTopDown3D.mutate({ pipelineId: pipeline.id });[m
[32m+[m[32m                        } else if (stepToRetry === 2) {[m
[32m+[m[32m                          const designRefIds = (stepOutputs as Record<string, unknown>)?.design_reference_ids as string[] || [];[m
[32m+[m[32m                          runStyleTopDown.mutate({ pipelineId: pipeline.id, designRefUploadIds: designRefIds });[m
[32m+[m[32m                        }[m
[32m+[m[32m                        // Add more steps as needed[m
[32m+[m[32m                      }}[m
[32m+[m[32m                      disabled={isRunning}[m
[32m+[m[32m                    >[m
[32m+[m[32m                      Retry Step {pipeline.current_step}[m
[32m+[m[32m                    </Button>[m
[32m+[m[32m                  </div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m              </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m          )}[m
[32m+[m
           {/* Persistent Source Floor Plan Viewer - syncs to Step 3 output when available */}[m
           <SourcePlanViewer[m
             floorPlanUploadId={pipeline.floor_plan_upload_id}[m
[1mdiff --git a/src/hooks/us