# REPAIR PLAN: Missing Output Display Elements

**Date**: 2026-02-12
**Issue**: Modular step components missing output display, comparison, QA, and approval UI
**Status**: ANALYSIS & PLANNING

---

## Problem Analysis

### User Discovery

> "Each step has its own output and whoever designed the UI forgot to add and know that there is also this aspect and that it needs to be shown. It's nice that they put each step in a state that can be collapsed by clicking on it, but it's not nice that they forgot the details."

**Critical Insight**: During the refactoring from `GlobalStepsSection` to modular step components, the **output display logic was lost**.

### What's Missing

Each step that produces visual outputs needs:

1. **Image Display Pane** - Show the generated output image(s)
2. **Compare Button** - Compare multiple outputs side-by-side
3. **QA Results Pane** - Display quality assurance results/feedback
4. **Approval Buttons** - Approve or Reject the output
5. **Grading Display** - Show quality score/grade
6. **Output Metadata** - Show attempt count, retry state, etc.

---

## Audit: Which Steps Need Output Displays?

### Step 0: Input Analysis
- **Produces Output**: ❌ No
- **Needs Display**: ❌ No
- **Status**: ✅ Complete (no outputs to show)

### Step 1: Realistic 2D Plan
- **Produces Output**: ✅ YES - Generates 2D floor plan image
- **Current State**: ⚠️ **INCOMPLETE**
  - ✅ Has run button
  - ⚠️ **Missing**: Image preview
  - ⚠️ **Missing**: QA results display
  - ⚠️ **Missing**: Approval/rejection buttons with QA awareness
  - ⚠️ **Missing**: Retry state display
  - ⚠️ **Missing**: Compare functionality
- **Needs Repair**: ✅ YES

### Step 2: Style Application
- **Produces Output**: ✅ YES - Generates styled floor plan image
- **Current State**: ⚠️ **INCOMPLETE**
  - ✅ Has run button
  - ⚠️ **Missing**: Image preview
  - ⚠️ **Missing**: QA results display
  - ⚠️ **Missing**: Approval/rejection buttons with QA awareness
  - ⚠️ **Missing**: Retry state display
  - ⚠️ **Missing**: Compare functionality
- **Needs Repair**: ✅ YES

### Step 3: Space Scan
- **Produces Output**: ⚠️ Partial - Detects spaces (data, not images)
- **Current State**: ⚠️ **INCOMPLETE**
  - ✅ Has run button
  - ✅ Shows detected spaces list
  - ⚠️ **Missing**: Space visualization (if applicable)
  - ⚠️ **Missing**: Retry state display
- **Needs Repair**: ⚠️ Maybe (depends on if spaces need visual display)

### Step 4: Camera Intent
- **Produces Output**: ⚠️ Data only - Camera intent suggestions
- **Current State**: ⚠️ **INCOMPLETE**
  - ✅ Has selection UI
  - ✅ Has confirm button
  - ⚠️ **Missing**: Visual preview of camera positions (if applicable)
- **Needs Repair**: ⚠️ Maybe (depends on design requirements)

### Step 5: Prompt Templates
- **Produces Output**: ⚠️ Data only - Final prompts
- **Current State**: ⚠️ **INCOMPLETE**
  - ✅ Shows prompts
  - ⚠️ **Missing**: Visual feedback on generation status
  - ⚠️ **Missing**: Edit functionality (planned but not implemented)
- **Needs Repair**: ⚠️ Maybe (edit feature needed)

### Step 6: Outputs + QA
- **Produces Output**: ✅ YES - Generated space renders
- **Current State**: ⚠️ **INCOMPLETE**
  - ✅ Has run button
  - ⚠️ **Missing**: Image gallery for all space outputs
  - ⚠️ **Missing**: Per-space QA results
  - ⚠️ **Missing**: Per-space approval/rejection
  - ⚠️ **Missing**: Compare functionality across spaces
- **Needs Repair**: ✅ YES

---

## Priority Repair List

### HIGH PRIORITY (Steps with Visual Outputs)

**Priority 1: Step 1 - Realistic 2D Plan**
- Most critical - first visual output users see
- Needs full output display implementation

**Priority 2: Step 2 - Style Application**
- Second visual output
- Similar requirements to Step 1

**Priority 3: Step 6 - Outputs + QA**
- Most complex - multiple space outputs
- Needs per-space display and approval

### MEDIUM PRIORITY (Steps with Partial Outputs)

**Priority 4: Step 3 - Space Scan**
- Currently shows list
- May need visual space overlay (check original design)

### LOW PRIORITY (Data-Only Steps)

**Priority 5: Step 4, 5**
- Primarily data/text display
- May need minor enhancements

---

## Required Components & Features

### 1. Image Preview Pane

**Purpose**: Display output images generated by a step

**Required Props**:
```typescript
interface ImagePreviewPaneProps {
  imageUrl: string | null;
  uploadId: string | null;
  stepNumber: number;
  stepName: string;
  isLoading?: boolean;
  error?: string;
  bucket: string; // e.g., "outputs", "floor_plans"
}
```

**Features**:
- Show image with loading state
- Zoom/pan controls
- Download button
- Fullscreen toggle
- Error state display

**Where Used**: Steps 1, 2, 6

---

### 2. QA Results Display

**Purpose**: Show quality assurance results for an output

**Required Props**:
```typescript
interface QAResultsDisplayProps {
  qaStatus: 'pending' | 'passed' | 'failed' | 'manual_review';
  qaScore?: number; // 0-100
  qaFeedback?: string;
  qaAttempt?: number;
  maxAttempts?: number;
  qaHistory?: Array<{
    attempt: number;
    status: string;
    score?: number;
    feedback?: string;
    timestamp: string;
  }>;
}
```

**Features**:
- Status badge (passed/failed/reviewing)
- Score display (if available)
- Feedback message
- Attempt counter (e.g., "Attempt 2/3")
- History accordion (show previous attempts)

**Where Used**: Steps 1, 2, 6

---

### 3. Approval/Rejection Buttons

**Purpose**: Allow user to approve or reject output (with QA awareness)

**Required Props**:
```typescript
interface ApprovalButtonsProps {
  stepNumber: number;
  outputUploadId: string;
  qaStatus: 'pending' | 'passed' | 'failed' | 'manual_review';
  canApprove: boolean; // Based on QA + manual override
  canReject: boolean;
  onApprove: () => Promise<void>;
  onReject: () => Promise<void>;
  isApproving?: boolean;
  isRejecting?: boolean;
  manualQAEnabled?: boolean;
}
```

**Features**:
- Conditional display based on QA status:
  - QA passed: Enable "Approve" button
  - QA failed: Enable "Reject" button, disable "Approve" unless manual override
  - QA pending: Show "Waiting for QA..." state
- Manual override option (if `manualQAEnabled`)
- Confirmation dialogs for both actions
- Loading states

**Where Used**: Steps 1, 2, 6

---

### 4. Retry State Indicator

**Purpose**: Show current retry attempt and allow manual retry

**Required Props**:
```typescript
interface RetryStateIndicatorProps {
  stepNumber: number;
  currentAttempt: number;
  maxAttempts: number;
  canRetry: boolean;
  onRetry: () => Promise<void>;
  onManualApprove?: () => Promise<void>; // After retry exhaustion
  onManualReject?: () => Promise<void>; // After retry exhaustion
}
```

**Features**:
- Show attempt counter (e.g., "Attempt 2/3")
- Progress indicator
- Retry button (if attempts remaining)
- Manual override options (if exhausted)
- Clear messaging about retry logic

**Where Used**: Steps 1, 2, 6

---

### 5. Compare Button & Modal

**Purpose**: Compare multiple outputs side-by-side

**Required Props**:
```typescript
interface CompareModalProps {
  outputs: Array<{
    id: string;
    imageUrl: string;
    label: string;
    attempt?: number;
    qaScore?: number;
  }>;
  onClose: () => void;
}
```

**Features**:
- Side-by-side image comparison
- Slider to switch between images
- Labels for each output (e.g., "Attempt 1", "Attempt 2")
- QA scores if available
- Zoom/pan controls

**Where Used**: Steps 1, 2, 6 (when multiple attempts exist)

---

### 6. Grading Display

**Purpose**: Show quality grade/score

**Required Props**:
```typescript
interface GradingDisplayProps {
  score: number; // 0-100
  grade: 'A' | 'B' | 'C' | 'D' | 'F' | null;
  criteria?: Array<{
    name: string;
    score: number;
    weight: number;
  }>;
}
```

**Features**:
- Overall score display (e.g., "85/100")
- Letter grade (if applicable)
- Criteria breakdown (accordion)
- Visual progress bar
- Color coding (green = good, red = bad)

**Where Used**: Steps 1, 2, 6

---

## Implementation Plan

### Phase 1: Audit Old GlobalStepsSection Code

**Goal**: Extract the display logic that was lost during refactoring

**Tasks**:
1. Read the OLD `GlobalStepsSection` code (if still exists in git history)
2. Identify all output display components used for Steps 1, 2, 3
3. Document the exact props and features each component had
4. Create a checklist of missing features per step

**Deliverable**: Audit document with before/after comparison

---

### Phase 2: Create Shared Display Components

**Goal**: Build reusable components for output display

**Tasks**:
1. Create `ImagePreviewPane` component
2. Create `QAResultsDisplay` component
3. Create `ApprovalButtons` component
4. Create `RetryStateIndicator` component
5. Create `CompareModal` component
6. Create `GradingDisplay` component

**Location**: `src/components/whole-apartment/shared/`

**Deliverable**: 6 new shared components

---

### Phase 3: Update Step 1 Component

**File**: `src/components/whole-apartment/steps/Step1_RealisticPlan.tsx`

**Add**:
1. Import shared display components
2. Add output display section (after run button)
3. Show image preview when output exists
4. Show QA results when available
5. Show approval/rejection buttons
6. Show retry state if applicable
7. Add compare button if multiple outputs exist

**Test Cases**:
- [ ] Run Step 1 → Image displays
- [ ] QA passes → Approve button enabled
- [ ] QA fails → Reject button enabled, Approve disabled (unless manual)
- [ ] Click Approve → Transitions to Step 2
- [ ] Click Reject → Retry triggered
- [ ] Retry exhausted → Manual override options shown
- [ ] Multiple attempts → Compare button appears
- [ ] Compare button → Modal shows side-by-side comparison

---

### Phase 4: Update Step 2 Component

**File**: `src/components/whole-apartment/steps/Step2_StyleApplication.tsx`

**Add**: Same as Step 1 (identical requirements)

**Test Cases**: Same as Step 1

---

### Phase 5: Update Step 6 Component

**File**: `src/components/whole-apartment/steps/Step6_OutputsQA.tsx`

**Add**:
1. Per-space output gallery
2. Expand/collapse per space
3. Image preview for each space
4. QA results per space
5. Approval/rejection per space
6. Compare within space (A vs B renders)
7. Batch approval option (approve all passing)

**Test Cases**:
- [ ] Run Step 6 → All space outputs display
- [ ] Expand space → See A/B renders
- [ ] QA results per render
- [ ] Approve individual render
- [ ] Compare A vs B within space
- [ ] Batch approve all passing renders
- [ ] See overall progress (X/Y spaces approved)

---

### Phase 6: Verify Step 3 Requirements

**File**: `src/components/whole-apartment/steps/Step3_SpaceScan.tsx`

**Investigate**:
- Does Step 3 need visual space overlay?
- Are space boundaries/labels shown on floor plan?
- Is there a "preview spaces" visualization?

**Action**: Decide if Step 3 needs additional visualization

---

### Phase 7: Polish Steps 4-5

**Files**:
- `src/components/whole-apartment/steps/Step4_CameraIntent.tsx`
- `src/components/whole-apartment/steps/Step5_PromptTemplates.tsx`

**Add**:
1. Step 4: Camera position visualization (if designed)
2. Step 5: Prompt editing functionality (currently TODO)

---

## Test Plan

### Test Checklist Per Step

For **Steps 1, 2, 6** (steps with visual outputs):

#### Visual Display Tests
- [ ] **Image loads correctly** after generation
- [ ] **Loading state** displays during generation
- [ ] **Error state** displays if generation fails
- [ ] **Placeholder** shows if no output yet
- [ ] **Image zoom/pan** works correctly
- [ ] **Download button** downloads the image
- [ ] **Fullscreen mode** works

#### QA Integration Tests
- [ ] **QA pending state** shows loading indicator
- [ ] **QA passed state** shows green badge + score
- [ ] **QA failed state** shows red badge + feedback
- [ ] **QA history** accordion shows all attempts
- [ ] **Retry counter** displays correctly (e.g., "Attempt 2/3")

#### Approval Workflow Tests
- [ ] **Approve button enabled** when QA passes
- [ ] **Approve button disabled** when QA fails (without manual override)
- [ ] **Manual override checkbox** enables approve when QA failed (if `manualQAEnabled`)
- [ ] **Reject button** always enabled (can reject any output)
- [ ] **Approve action** triggers phase transition
- [ ] **Reject action** triggers retry
- [ ] **Confirmation dialogs** appear for both actions
- [ ] **Loading states** during approval/rejection

#### Retry Logic Tests
- [ ] **Retry triggered** automatically after rejection
- [ ] **Attempt counter increments** on each retry
- [ ] **Max attempts respected** (e.g., stops at 3)
- [ ] **Retry exhaustion** shows manual override options
- [ ] **Manual approve** button works after exhaustion
- [ ] **Manual reject** button works after exhaustion

#### Compare Functionality Tests
- [ ] **Compare button hidden** when only 1 output
- [ ] **Compare button visible** when multiple outputs exist
- [ ] **Compare modal opens** on button click
- [ ] **Side-by-side images** display correctly
- [ ] **Slider switches** between outputs
- [ ] **Labels show** attempt numbers
- [ ] **QA scores display** if available
- [ ] **Modal closes** with Escape or X button

#### Grading Display Tests
- [ ] **Score displays** correctly (e.g., "85/100")
- [ ] **Letter grade** matches score (if shown)
- [ ] **Progress bar** fills proportionally
- [ ] **Color coding** correct (green/yellow/red)
- [ ] **Criteria breakdown** shows in accordion
- [ ] **Weighted criteria** calculated correctly

---

## E2E Test Scenarios

### Scenario 1: Happy Path (All QA Passes)

1. Run Step 1 → Image generates
2. Wait for QA → QA passes (score 95/100)
3. Image displays with green QA badge
4. Approve button enabled
5. Click Approve → Transitions to Step 2
6. Run Step 2 → Image generates
7. Wait for QA → QA passes (score 88/100)
8. Approve → Transitions to Step 3
9. ... continue through pipeline
10. All steps complete successfully

**Expected**: Smooth progression, no retry needed

---

### Scenario 2: QA Fails, Retry Succeeds

1. Run Step 1 → Image generates
2. Wait for QA → QA fails (score 45/100, "Low quality")
3. Image displays with red QA badge
4. Approve button disabled (or requires manual override)
5. Reject button enabled
6. Click Reject → Retry triggered (Attempt 2)
7. Wait for retry generation → Image generates
8. Wait for QA → QA passes (score 92/100)
9. Green QA badge shown
10. Click Approve → Proceeds to Step 2

**Expected**: Automatic retry works, second attempt succeeds

---

### Scenario 3: Retry Exhaustion, Manual Override

1. Run Step 1 → Image generates (Attempt 1)
2. QA fails → Reject → Retry (Attempt 2)
3. QA fails → Reject → Retry (Attempt 3)
4. QA fails → Retry exhausted
5. Manual override UI appears:
   - "All 3 attempts failed QA. Manual review required."
   - Button: "Approve Anyway"
   - Button: "Reject and Stop Pipeline"
6. User clicks "Approve Anyway"
7. Proceeds to Step 2 with warning

**Expected**: Manual override prevents pipeline from being stuck

---

### Scenario 4: Compare Multiple Outputs

1. Run Step 1 → Generates (Attempt 1, QA failed)
2. Retry → Generates (Attempt 2, QA failed)
3. Retry → Generates (Attempt 3, QA passed)
4. Compare button appears (3 outputs available)
5. Click Compare → Modal opens
6. See all 3 attempts side-by-side
7. Slider to switch between them
8. Labels: "Attempt 1 (QA: 40)", "Attempt 2 (QA: 55)", "Attempt 3 (QA: 90)"
9. User can visually compare to understand improvements
10. Close modal → Select best output to approve

**Expected**: Compare helps users understand retry improvements

---

### Scenario 5: Step 6 Multiple Spaces

1. Run Step 6 → Batch render starts
2. 3 spaces (Living Room, Kitchen, Bedroom)
3. Each space shows:
   - Render A (generating → complete)
   - Render B (generating → complete)
4. QA runs per render
5. Living Room: Both passed → Approve both
6. Kitchen: Render A passed, Render B failed → Approve A, Reject B
7. Bedroom: Both failed → Reject both, trigger retry
8. Overall progress: "4/6 renders approved"
9. Batch action: "Approve All Passing" (approves remaining passed renders)
10. Wait for Kitchen/Bedroom retries
11. All approved → Proceed

**Expected**: Per-space granular control + batch actions

---

## Component Architecture

### Shared Components Location

```
src/components/whole-apartment/shared/
├── ImagePreviewPane.tsx
├── QAResultsDisplay.tsx
├── ApprovalButtons.tsx
├── RetryStateIndicator.tsx
├── CompareModal.tsx
├── GradingDisplay.tsx
└── index.ts (barrel export)
```

### Usage in Step Components

```tsx
// Example: Step1_RealisticPlan.tsx

import {
  ImagePreviewPane,
  QAResultsDisplay,
  ApprovalButtons,
  RetryStateIndicator,
  CompareModal
} from "@/components/whole-apartment/shared";

export function Step1_RealisticPlan() {
  const { pipeline, imagePreviews } = usePipelineContext();
  const [compareOpen, setCompareOpen] = useState(false);

  const stepOutputs = pipeline.step_outputs || {};
  const step1Output = stepOutputs["step1"] || stepOutputs["1"];
  const outputUploadId = step1Output?.upload_id;
  const qaStatus = step1Output?.qa_status;
  const qaScore = step1Output?.qa_score;
  const retryState = pipeline.step_retry_state?.[1];

  return (
    <StepContainer stepNumber="1" stepName="Realistic 2D Plan" ...>
      {/* Run Button (existing) */}
      <Button onClick={handleRun}>Generate 2D Plan</Button>

      {/* Output Display (NEW) */}
      {outputUploadId && (
        <div className="space-y-4 mt-4">
          {/* Image Preview */}
          <ImagePreviewPane
            imageUrl={imagePreviews[outputUploadId]}
            uploadId={outputUploadId}
            stepNumber={1}
            stepName="2D Plan"
            bucket="outputs"
          />

          {/* QA Results */}
          <QAResultsDisplay
            qaStatus={qaStatus}
            qaScore={qaScore}
            qaFeedback={step1Output?.qa_feedback}
            qaAttempt={retryState?.attempt_count}
            maxAttempts={3}
          />

          {/* Retry State */}
          {retryState && (
            <RetryStateIndicator
              stepNumber={1}
              currentAttempt={retryState.attempt_count}
              maxAttempts={3}
              canRetry={retryState.attempt_count < 3}
              onRetry={handleRetry}
            />
          )}

          {/* Approval Buttons */}
          <ApprovalButtons
            stepNumber={1}
            outputUploadId={outputUploadId}
            qaStatus={qaStatus}
            canApprove={qaStatus === 'passed'}
            canReject={true}
            onApprove={handleApprove}
            onReject={handleReject}
          />

          {/* Compare Button (if multiple outputs) */}
          {retryState?.attempt_count > 1 && (
            <Button onClick={() => setCompareOpen(true)}>
              Compare Attempts
            </Button>
          )}
        </div>
      )}

      {/* Compare Modal */}
      {compareOpen && (
        <CompareModal
          outputs={getAllAttemptOutputs()}
          onClose={() => setCompareOpen(false)}
        />
      )}

      {/* Reset/Rollback Buttons (existing) */}
      <StepControlsFooter ... />
    </StepContainer>
  );
}
```

---

## Success Criteria

### Step 1 Complete When:
- [ ] Image preview displays after generation
- [ ] QA results show pass/fail status
- [ ] Approval buttons conditional on QA
- [ ] Retry logic works correctly
- [ ] Compare modal works for multiple attempts
- [ ] All test cases pass

### Step 2 Complete When:
- [ ] Same as Step 1 (identical requirements)

### Step 6 Complete When:
- [ ] All space outputs display
- [ ] Per-space QA and approval
- [ ] Compare within space (A vs B)
- [ ] Batch approval works
- [ ] All test cases pass

### Overall Complete When:
- [ ] All 6 shared components created
- [ ] Steps 1, 2, 6 fully implemented
- [ ] All E2E scenarios pass
- [ ] Manual QA confirms UI matches old functionality
- [ ] No regressions in existing features

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Components don't match old UI exactly | Medium | Medium | Review old screenshots/videos before implementing |
| QA integration breaks | Low | High | Test QA workflow thoroughly, check backend contracts |
| Performance issues with multiple images | Medium | Low | Use lazy loading, optimize image sizes |
| Compare modal UX poor | Medium | Medium | Test with real outputs, iterate on design |
| Missing edge cases in retry logic | Medium | High | Review retry state machine, add exhaustive tests |

---

## Timeline Estimate

- **Phase 1 (Audit)**: 2-3 hours
- **Phase 2 (Shared Components)**: 8-10 hours
- **Phase 3 (Step 1)**: 4-5 hours
- **Phase 4 (Step 2)**: 3-4 hours (similar to Step 1)
- **Phase 5 (Step 6)**: 6-8 hours (more complex)
- **Phase 6 (Step 3 verify)**: 1-2 hours
- **Phase 7 (Polish 4-5)**: 2-3 hours
- **Testing & QA**: 4-6 hours

**Total**: ~30-40 hours of development work

---

## Next Steps

1. **Review this plan** with stakeholders
2. **Approve scope** - confirm all missing features should be added
3. **Prioritize phases** - which steps are most critical?
4. **Check git history** - find old GlobalStepsSection code for reference
5. **Begin Phase 1** - audit old code and document missing features

---

**Status**: PLANNING COMPLETE - AWAITING APPROVAL TO PROCEED
**Priority**: HIGH (Critical missing functionality)
**Effort**: Large (30-40 hours estimated)
